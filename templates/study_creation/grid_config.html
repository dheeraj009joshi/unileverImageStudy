{% extends "base.html" %}

{% block title %}Grid Study Configuration - Study Creation{% endblock %}

{% block content %}
<div class="study-creation-container">
    <div class="study-creation-header">
        <h1>Grid Study Configuration</h1>
        <p>Configure categories and elements for your grid study</p>
    </div>

    {{ study_progress_bar('grid_config', 'grid', draft) }}

    <div class="form-container">
        <form method="POST" class="study-form" enctype="multipart/form-data" id="gridConfigForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="form-section">
                <div class="section-header">
                    <h3>Categories Configuration</h3>
                    <div class="category-actions">
                        <button type="button" class="btn btn--primary" onclick="openAddCategoryModal()">
                            ‚ïã Add Category
                        </button>
                        <span class="category-count">
                            <span id="categoryCount">{{ categories_data|length if categories_data else 0 }}</span>/10 categories
                        </span>
                    </div>
                </div>
                
                <p class="form-help">Add categories to organize your elements. Each category can contain multiple elements. Minimum 3 categories, maximum 10.</p>
                
                <!-- Categories Container -->
                <div id="categoriesContainer" class="categories-container">
                    {% if categories_data %}
                        {% for category in categories_data %}
                            <div class="category-card" data-category-id="{{ category.category_id }}">
                                <div class="category-header">
                                    <div class="category-info">
                                        <h4>{{ category.category_name }}</h4>
                                        <p class="category-description">{{ category.category_description or 'No description' }}</p>
                                        <span class="elements-count">{{ category.elements|length }} elements</span>
                                    </div>
                                    <div class="category-actions">
                                        <button type="button" class="btn btn--sm btn--secondary" onclick="editCategory('{{ category.category_id }}')">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button type="button" class="btn btn--sm btn--danger" onclick="deleteCategory('{{ category.category_id }}')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="category-elements">
                                    {% for element in category.elements %}
                                        <div class="element-item">
                                            <span class="element-name">{{ element.name }}</span>
                                            {% if element.element_type == 'image' %}
                                                <img src="{{ element.content }}" alt="{{ element.alt_text }}" class="element-preview">
                                            {% else %}
                                                <span class="element-type">{{ element.element_type }}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <p>No categories added yet. Click "Add Category" to get started.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn--primary" id="saveButton" {% if not categories_data or categories_data|length < 2 %}disabled{% endif %}>
                    Save Categories & Continue
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div id="categoryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add Category</h3>
            <button type="button" class="modal-close" onclick="closeCategoryModal()">&times;</button>
        </div>
        
        <form id="categoryForm" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" name="category_name" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="categoryDescription">Category Description</label>
                    <textarea id="categoryDescription" name="category_description" class="form-textarea" placeholder="Describe what this category represents..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Elements</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="elementFiles" name="element_files" multiple accept="image/*" style="display: none;" required>
                        <div class="upload-zone" onclick="document.getElementById('elementFiles').click()">
                            <div class="upload-icon">üìÅ</div>
                            <p>Click to select multiple images</p>
                            <small>Or drag and drop files here</small>
                        </div>
                    </div>
                    
                    <div id="selectedFiles" class="selected-files">
                        <div class="empty-state" style="text-align: center; color: #666; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÅ</div>
                            <div>No files selected</div>
                            <small>Select images to see previews here</small>
                        </div>
                    </div>
                    
                    <!-- Debug buttons -->
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button type="button" onclick="testAddFile()" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px;">Test Add File</button>
                        <button type="button" onclick="refreshExistingElements()" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px;">Refresh Elements</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn--secondary" onclick="closeCategoryModal()">Cancel</button>
                <button type="button" class="btn btn--primary" onclick="saveCategory()">Save Category</button>
            </div>
        </form>
    </div>
</div>

<style>
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.category-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.category-count {
    font-size: 0.9rem;
    color: #666;
}

.categories-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.category-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.category-info h4 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.category-description {
    margin: 0 0 0.5rem 0;
    color: #666;
    font-size: 0.9rem;
}

.elements-count {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
}

.category-actions {
    display: flex;
    gap: 0.5rem;
}

.category-elements {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.element-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem;
    background: #f5f5f5;
    border-radius: 6px;
    font-size: 0.75rem;
    min-width: 60px;
}

.element-preview {
    
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.element-preview-placeholder {
    width: 40px;
    height: 40px;
    background: #e3f2fd;
    color: #1976d2;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 16px;
    border: 1px solid #ddd;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    max-height: 95vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    border-bottom: 1px solid #ddd;
    background: #f8f9fa;
    flex-shrink: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 2rem;
    flex: 1;
    overflow-y: auto;
    min-height: 0;
}

.modal-footer {
    padding: 1rem 2rem;
    border-top: 1px solid #ddd;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    background: #f8f9fa;
    flex-shrink: 0;
}

.file-upload-area {
    margin-top: 0.5rem;
}

.upload-zone {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s;
    min-height: 80px;
}

.upload-zone:hover {
    border-color: #007bff;
}

.upload-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.selected-files {
    margin-top: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1rem;
    min-height: 200px;
    background: #f8f9fa;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.file-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.file-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.file-preview {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: #fff;
}

.file-info {
    text-align: center;
    width: 100%;
}

.file-preview-placeholder {
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: #f8f9fa;
    color: #6c757d;
}

.file-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
    word-break: break-word;
    font-size: 0.9rem;
    line-height: 1.2;
}

.file-size {
    font-size: 0.8rem;
    color: #666;
}

.remove-file {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    font-size: 0.8rem;
}
</style>

<script>
let categories = {{ categories_data|tojson if categories_data else '[]' }};
let editingCategoryId = null;

function openAddCategoryModal() {
    if (categories.length >= 12) {
        alert('Maximum 12 categories allowed');
        return;
    }
    
    editingCategoryId = null;
    document.getElementById('modalTitle').textContent = 'Add Category';
    document.getElementById('categoryForm').reset();
    document.getElementById('selectedFiles').innerHTML = '';
    // Clear the file input to prevent processing old files
    document.getElementById('elementFiles').value = '';
    document.getElementById('categoryModal').style.display = 'flex';
}

function editCategory(categoryId) {
    const category = categories.find(c => c.category_id === categoryId);
    if (!category) return;
    
    editingCategoryId = categoryId;
    document.getElementById('modalTitle').textContent = 'Edit Category';
    document.getElementById('categoryName').value = category.category_name;
    document.getElementById('categoryDescription').value = category.category_description || '';
    document.getElementById('selectedFiles').innerHTML = '';
    
    // Clear the file input to prevent processing old files
    document.getElementById('elementFiles').value = '';
    
    // Show existing elements
    category.elements.forEach((element, index) => {
        if (element.element_type === 'image') {
            addFileToPreview(element.name, element.content, true);
        }
    });
    
    // Refresh elements after a short delay to ensure proper display
    setTimeout(() => {
        refreshExistingElements();
    }, 100);
    
    document.getElementById('categoryModal').style.display = 'flex';
}

function deleteCategory(categoryId) {
    if (categories.length <= 2) {
        alert('Minimum 2 categories required');
        return;
    }
    
    if (confirm('Are you sure you want to delete this category?')) {
        categories = categories.filter(c => c.category_id !== categoryId);
        updateCategoriesDisplay();
        updateSaveButton();
    }
}

function closeCategoryModal() {
    document.getElementById('categoryModal').style.display = 'none';
}

async function saveCategory() {
    const name = document.getElementById('categoryName').value.trim();
    const description = document.getElementById('categoryDescription').value.trim();
    const files = document.getElementById('elementFiles').files;
    
    if (!name) {
        alert('Please enter a category name');
        return;
    }
    
    // Only require files for new categories, not when editing existing ones
    if (files.length === 0 && !editingCategoryId) {
        alert('Please select at least one element file');
        return;
    }
    
    // If editing and no files selected, just update name/description
    if (files.length === 0 && editingCategoryId) {
        console.log(`üìù Editing category "${name}" - no new files, updating name/description only`);
    }
    
    // Check if there are pending uploads
    const fileItems = document.querySelectorAll('.file-item[data-file-name]');
    const pendingUploads = [];
    const uploadingUploads = [];
    
    fileItems.forEach(fileItem => {
        const statusText = fileItem.querySelector('.file-size');
        const fileName = fileItem.dataset.fileName;
        
        if (statusText) {
            if (statusText.textContent === 'Uploading...') {
                uploadingUploads.push(fileName);
            } else if (statusText.textContent === 'Upload failed ‚úó') {
                pendingUploads.push(fileName);
            }
        }
    });
    
    if (pendingUploads.length > 0) {
        alert(`Please fix failed uploads first. ${pendingUploads.length} upload(s) failed: ${pendingUploads.join(', ')}`);
        return;
    }
    
    if (uploadingUploads.length > 0) {
        alert(`Please wait for all images to finish uploading. ${uploadingUploads.length} upload(s) still in progress: ${uploadingUploads.join(', ')}`);
        return;
    }
    
    const categoryData = {
        category_name: name,
        category_description: description,
        elements: []
    };
    
    if (editingCategoryId) {
        // Editing existing category - preserve existing elements
        const existingCategory = categories.find(c => c.category_id === editingCategoryId);
        if (existingCategory) {
            categoryData.category_id = existingCategory.category_id;
            categoryData.elements = [...existingCategory.elements]; // Copy existing elements
            console.log(`üìã Editing category "${name}" - preserving ${existingCategory.elements.length} existing elements`);
        }
    } else {
        // New category
        categoryData.category_id = generateCategoryId();
        console.log(`üÜï Creating new category "${name}"`);
    }
    
    // Only process new files if files are selected (not when just editing name/description)
    if (files.length > 0) {
        console.log(`üìÅ Processing ${files.length} new files for category "${name}"`);
        console.log(`üìã Current elements count before processing: ${categoryData.elements.length}`);
        
        // Process new files - use Azure URLs from upload results
    console.log('üîç Processing files for category:', name);
    console.log('üìÅ Files to process:', Array.from(files).map(f => f.name));
    console.log('üìä Current upload results:', window.currentUploadResults);
    
    const filePromises = Array.from(files).map(async (file, index) => {
        if (file.type.startsWith('image/')) {
            // First try to find the upload result for this file
            let uploadResult = window.currentUploadResults?.find(r => r.file.name === file.name);
            console.log(`üîç Looking for upload result for ${file.name}:`, uploadResult);
            
            // If not found, try to find it by looking at the file item in the DOM
            if (!uploadResult) {
                const fileItem = document.querySelector(`[data-file-name="${file.name}"]`);
                console.log(`üîç File item in DOM for ${file.name}:`, fileItem);
                if (fileItem && fileItem.dataset.azureUrl) {
                    uploadResult = { success: true, azureUrl: fileItem.dataset.azureUrl };
                    console.log(`‚úÖ Found Azure URL in DOM for ${file.name}: ${fileItem.dataset.azureUrl}`);
                }
            }
            
            if (!uploadResult || !uploadResult.success) {
                console.error(`No successful upload found for ${file.name}`);
                // Create a data URL preview as fallback - this will be used temporarily
                const previewUrl = await createFilePreviewUrl(file);
                const elementData = {
                    element_id: generateElementId(),
                    name: file.name || `Element ${index + 1}`,
                    description: '',
                    element_type: 'image',
                    content: previewUrl, // Use data URL as fallback
                    alt_text: file.name || `Element ${index + 1}`,
                    file: file // Store the file for later upload
                };
                console.log(`‚ö†Ô∏è Using data URL preview for ${file.name} - will upload in background`);
                return elementData;
            }
            
            const elementData = {
                element_id: generateElementId(),
                name: file.name|| `Element ${index + 1}`,
                description: '',
                element_type: 'image',
                content: uploadResult.azureUrl, // Use the successful Azure URL
                alt_text: file.name || `Element ${index + 1}`
            };
            
            console.log(`‚úÖ Element created for ${file.name} with Azure URL: ${uploadResult.azureUrl}`);
            return elementData;
        }
        return null;
    });
    
        const newElements = (await Promise.all(filePromises)).filter(el => el !== null);
        
        // Filter out duplicates by checking if element name already exists
        const existingElementNames = categoryData.elements.map(el => el.name);
        const uniqueNewElements = newElements.filter(el => !existingElementNames.includes(el.name));
        
        if (uniqueNewElements.length !== newElements.length) {
            console.log(`‚ö†Ô∏è Filtered out ${newElements.length - uniqueNewElements.length} duplicate elements`);
        }
        
        categoryData.elements = [...categoryData.elements, ...uniqueNewElements];
        console.log(`‚úÖ Added ${uniqueNewElements.length} new elements to category "${name}"`);
        console.log(`üìä Total elements after adding: ${categoryData.elements.length}`);
    }
    
    if (editingCategoryId) {
        // Update existing category
        const index = categories.findIndex(c => c.category_id === editingCategoryId);
        if (index !== -1) {
            categories[index] = categoryData;
        }
    } else {
        // Add new category
        categories.push(categoryData);
    }
    
    updateCategoriesDisplay();
    updateSaveButton();
    closeCategoryModal();
    
    // Clear the upload results after successful save
    window.currentUploadResults = null;
    console.log('‚úÖ Category saved successfully, cleared upload results');
}

function updateCategoriesDisplay() {
    const container = document.getElementById('categoriesContainer');
    
    if (categories.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No categories added yet. Click "Add Category" to get started.</p></div>';
        return;
    }
    
    container.innerHTML = categories.map(category => `
        <div class="category-card" data-category-id="${category.category_id}">
            <div class="category-header">
                <div class="category-info">
                    <h4>${category.category_name}</h4>
                    <p class="category-description">${category.category_description || 'No description'}</p>
                    <span class="elements-count">${category.elements.length} elements</span>
                </div>
                <div class="category-actions">
                    <button type="button" class="btn btn--sm btn--secondary" onclick="editCategory('${category.category_id}')">
                        ‚úèÔ∏è Edit
                    </button>
                    <button type="button" class="btn btn--sm btn--danger" onclick="deleteCategory('${category.category_id}')">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
            
            <div class="category-elements">
                ${category.elements.map(element => `
                    <div class="element-item">
                        <span class="element-name">${element.name}</span>
                        ${element.element_type === 'image' ? 
                            (element.content && element.content !== 'null' && element.content !== '' ? 
                                `<img src="${element.content}" alt="${element.alt_text}" class="element-preview" onerror="console.error('Failed to load image:', '${element.content}'); this.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="element-preview-placeholder" style="display:none;">üì∑</div>` :
                                `<div class="element-preview-placeholder">üì∑</div>`
                            ) :
                            `<span class="element-type">${element.element_type}</span>`
                        }
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
    
    document.getElementById('categoryCount').textContent = categories.length;
}

function updateSaveButton() {
    const saveButton = document.getElementById('saveButton');
    saveButton.disabled = categories.length < 2;
}

function generateCategoryId() {
    return 'cat_' + Math.random().toString(36).substr(2, 9);
}

function generateElementId() {
    return 'elem_' + Math.random().toString(36).substr(2, 9);
}

async function addFileToPreview(fileName, fileUrl, isExisting = false) {
    console.log(`üîç Adding file to preview: ${fileName}, URL: ${fileUrl}, isExisting: ${isExisting}`);
    const container = document.getElementById('selectedFiles');
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    
    if (isExisting) {
        // Check if fileUrl is valid
        const hasValidUrl = fileUrl && fileUrl.trim() !== '' && fileUrl !== 'null' && fileUrl !== 'undefined';
        console.log(`üîç Existing element: ${fileName}, URL: ${fileUrl}, Valid: ${hasValidUrl}`);
        
        if (hasValidUrl) {
            fileItem.innerHTML = `
                <img src="${fileUrl}" alt="${fileName}" class="file-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="file-preview-placeholder" style="display: none;">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                </div>
                <div class="file-info">
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">Existing element</div>
                </div>
            `;
        } else {
            // No valid URL, show placeholder
            fileItem.innerHTML = `
                <div class="file-preview-placeholder">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                </div>
                <div class="file-info">
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">Existing element (no preview)</div>
                </div>
            `;
        }
    } else {
        // For new files, create a preview URL
        let previewUrl = fileUrl;
        if (!previewUrl) {
            // Find the file object and create preview
            const files = document.getElementById('elementFiles').files;
            const file = Array.from(files).find(f => f.name === fileName);
            if (file) {
                previewUrl = await createFilePreviewUrl(file);
            }
        }
        
        if (previewUrl && previewUrl.trim() !== '') {
            fileItem.innerHTML = `
                <img src="${previewUrl}" alt="${fileName}" class="file-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="file-preview-placeholder" style="display: none;">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                </div>
                <div class="file-info">
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">Uploading...</div>
                </div>
                <button type="button" class="remove-file" onclick="removeFileFromPreview(this)">Remove</button>
            `;
        } else {
            // No preview URL available, show placeholder
            fileItem.innerHTML = `
                <div class="file-preview-placeholder">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                </div>
                <div class="file-info">
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">Processing...</div>
                </div>
                <button type="button" class="remove-file" onclick="removeFileFromPreview(this)">Remove</button>
            `;
        }
        fileItem.dataset.fileName = fileName;
    }
    
    console.log(`üìÅ Appending file item to container for: ${fileName}`);
    container.appendChild(fileItem);
    console.log(`üìÅ File item appended successfully for: ${fileName}`);
    console.log(`üìÅ Container now has ${container.children.length} children`);
    
    // Hide empty state if it exists
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    return fileItem; // Return the file item for later updates
}

// Function to create a preview URL from a file
function createFilePreviewUrl(file) {
    return new Promise((resolve) => {
        console.log(`üì∑ Creating preview URL for file: ${file.name}, size: ${file.size}, type: ${file.type}`);
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log(`‚úÖ Preview URL created for ${file.name}: ${e.target.result.substring(0, 50)}...`);
            resolve(e.target.result);
        };
        reader.onerror = function(e) {
            console.error(`‚ùå Error creating preview URL for ${file.name}:`, e);
            resolve('');
        };
        reader.readAsDataURL(file);
    });
}

// Function to update element URL in category data when upload completes
function updateElementUrlInCategory(fileName, azureUrl) {
    // Find the element in the current category being edited
    if (editingCategoryId) {
        const category = categories.find(c => c.category_id === editingCategoryId);
        if (category) {
            const elementName = fileName.split('.')[0];
            const element = category.elements.find(el => el.name === elementName);
            if (element) {
                const oldContent = element.content;
                element.content = azureUrl;
                console.log(`üîÑ Updated element "${fileName}" (${elementName}) from "${oldContent}" to Azure URL: ${azureUrl}`);
            } else {
                console.log(`‚ö†Ô∏è Element not found for fileName: ${fileName}, elementName: ${elementName}`);
                console.log(`üìã Available elements:`, category.elements.map(el => el.name));
            }
        }
    } else {
        console.log(`‚ö†Ô∏è No editingCategoryId set when trying to update element URL for ${fileName}`);
    }
}

// Function to upload file to Azure immediately
async function uploadFileToAzure(file) {
    try {
        console.log('Starting upload for file:', file.name);
        const formData = new FormData();
        formData.append('file', file);
        formData.append('immediate_upload', 'true'); // Flag to indicate immediate upload
        formData.append('csrf_token', document.querySelector('[name="csrf_token"]').value);
        
        const response = await fetch('/study/create/upload-immediate', {
            method: 'POST',
            body: formData
        });
        
        console.log('Upload response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Upload successful:', result);
            return result.url;
        } else {
            const errorText = await response.text();
            console.error('Upload failed with status:', response.status, 'Error:', errorText);
            throw new Error(`Upload failed: ${response.status} - ${errorText}`);
        }
    } catch (error) {
        console.error('Error uploading file:', error);
        return null;
    }
}

function removeFileFromPreview(button) {
    button.parentElement.remove();
}

// Test function to debug file preview
function testAddFile() {
    console.log('üß™ Testing file preview functionality');
    const container = document.getElementById('selectedFiles');
    if (!container) {
        console.error('‚ùå selectedFiles container not found!');
        alert('Container not found!');
        return;
    }
    
    console.log('üß™ Container found, adding test file item');
    const testItem = document.createElement('div');
    testItem.className = 'file-item';
    testItem.innerHTML = `
        <div class="file-preview-placeholder">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21,15 16,10 5,21"/>
            </svg>
        </div>
        <div class="file-info">
            <div class="file-name">Test File.jpg</div>
            <div class="file-size">Test upload</div>
        </div>
        <button type="button" class="remove-file" onclick="removeFileFromPreview(this)">Remove</button>
    `;
    
    container.appendChild(testItem);
    console.log('üß™ Test file item added successfully');
    console.log(`üß™ Container now has ${container.children.length} children`);
}

// Function to refresh existing elements with better previews
function refreshExistingElements() {
    console.log('üîÑ Refreshing existing elements');
    const container = document.getElementById('selectedFiles');
    if (!container) return;
    
    // Get all existing file items
    const fileItems = container.querySelectorAll('.file-item');
    fileItems.forEach((item, index) => {
        const fileName = item.querySelector('.file-name')?.textContent;
        const fileSize = item.querySelector('.file-size')?.textContent;
        
        console.log(`üîÑ Refreshing item ${index}: ${fileName}, status: ${fileSize}`);
        
        // If it's an existing element with no preview, try to improve the display
        if (fileSize === 'Existing element (no preview)' || fileSize === 'Existing element') {
            const img = item.querySelector('.file-preview');
            if (!img || img.src === '' || img.src.includes('undefined') || img.src.includes('null')) {
                console.log(`üîÑ Converting ${fileName} to placeholder display`);
                const placeholder = item.querySelector('.file-preview-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
                if (img) {
                    img.style.display = 'none';
                }
            }
        }
    });
}

// Handle file selection
document.getElementById('elementFiles').addEventListener('change', async function(e) {
    console.log('üìÅ File selection changed');
    const files = Array.from(e.target.files);
    console.log(`üìÅ Selected ${files.length} files:`, files.map(f => f.name));
    
    // Files selected - no alert needed
    
    const container = document.getElementById('selectedFiles');
    if (!container) {
        console.error('‚ùå selectedFiles container not found!');
        return;
    }
    
    console.log('üìÅ Container found, clearing existing previews');
    
    // Clear existing previews and empty state
    const existingItems = container.querySelectorAll('.file-item:not(:has(.remove-file))');
    console.log(`üìÅ Found ${existingItems.length} existing items`);
    container.innerHTML = '';
    existingItems.forEach(item => container.appendChild(item));
    
    // First, create all previews immediately with data URLs
    console.log('üìÅ Creating previews for files...');
    const previewPromises = files.map(async (file) => {
        console.log(`üìÅ Processing file: ${file.name}, type: ${file.type}`);
        if (file.type.startsWith('image/')) {
            console.log(`üìÅ Creating preview for image: ${file.name}`);
            const previewUrl = await createFilePreviewUrl(file);
            console.log(`üìÅ Preview URL created, adding to preview: ${file.name}`);
            const fileItem = await addFileToPreview(file.name, previewUrl, false);
            console.log(`üìÅ File item created for: ${file.name}`);
            return { file, previewUrl, fileItem };
        } else {
            console.log(`‚ö†Ô∏è Skipping non-image file: ${file.name}`);
        }
        return null;
    });
    
    console.log('üìÅ Waiting for all preview promises...');
    const previewResults = (await Promise.all(previewPromises)).filter(p => p !== null);
    console.log(`üìÅ Preview results: ${previewResults.length} files processed`);
    
    // Then upload all files in parallel
    console.log(`üöÄ Starting parallel upload of ${previewResults.length} files`);
    const uploadPromises = previewResults.map(async ({ file, fileItem }) => {
        try {
            const azureUrl = await uploadFileToAzure(file);
            if (azureUrl) {
                // Update the preview with the Azure URL
                const img = fileItem.querySelector('.file-preview');
                if (img) {
                    img.src = azureUrl;
                }
                // Update the status text
                const statusText = fileItem.querySelector('.file-size');
                if (statusText) {
                    statusText.textContent = 'Uploaded ‚úì';
                    statusText.style.color = '#28a745';
                }
                // Store the Azure URL for later use
                fileItem.dataset.azureUrl = azureUrl;
                fileItem.dataset.uploadSuccess = 'true';
                
                // Update the element URL in category data
                updateElementUrlInCategory(file.name, azureUrl);
                console.log(`‚úÖ Uploaded: ${file.name} -> ${azureUrl}`);
                return { success: true, file, azureUrl };
            } else {
                throw new Error('Upload returned null URL');
            }
        } catch (error) {
            console.error(`‚ùå Upload failed for ${file.name}:`, error);
            // Update status if upload failed
            const statusText = fileItem.querySelector('.file-size');
            if (statusText) {
                statusText.textContent = 'Upload failed ‚úó';
                statusText.style.color = '#dc3545';
            }
            return { success: false, file, error };
        }
    });
    
    // Wait for all uploads to complete
    const uploadResults = await Promise.all(uploadPromises);
    const successfulUploads = uploadResults.filter(r => r.success);
    const failedUploads = uploadResults.filter(r => !r.success);
    
    console.log(`üìä Upload Summary: ${successfulUploads.length} successful, ${failedUploads.length} failed`);
    
    // Store upload results globally for save validation
    window.currentUploadResults = uploadResults;
});

// Handle drag and drop
const uploadZone = document.querySelector('.upload-zone');
uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.borderColor = '#007bff';
});

uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.borderColor = '#ccc';
});

uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = '#ccc';
    
    const files = Array.from(e.dataTransfer.files);
    const fileInput = document.getElementById('elementFiles');
    
    // Create a new FileList
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    fileInput.files = dt.files;
    
    // Trigger change event (which will handle parallel uploads)
    fileInput.dispatchEvent(new Event('change'));
});

// Handle form submission
document.getElementById('gridConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (categories.length < 2) {
        alert('Please add at least 2 categories');
        return;
    }
    
    // Show loading overlay and disable submit
    const saveBtn = document.getElementById('saveButton');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
    }
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        const textEl = overlay.querySelector('.loading-overlay-text');
        if (textEl) textEl.textContent = 'Saving categories...';
        overlay.classList.add('is-visible');
    }

    // Create form data
    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('[name="csrf_token"]').value);
    
    // Clean up categories data - files are already uploaded
    const cleanedCategories = categories.map(category => ({
        ...category,
        elements: category.elements.map(element => {
            const cleanedElement = { ...element };
            // Remove any file references since files are already uploaded
            delete cleanedElement.file;
            return cleanedElement;
        })
    }));
    
    // Validate that all elements have proper Azure URLs
    // Check for elements that have neither Azure URLs nor data URLs (truly invalid)
    const elementsWithInvalidUrls = cleanedCategories.flatMap(cat => 
        cat.elements.filter(el => !el.content || (el.content !== 'null' && el.content !== '' && !el.content.startsWith('data:') && !el.content.startsWith('http')))
    );
    
    if (elementsWithInvalidUrls.length > 0) {
        alert(`Some images are not properly uploaded. Please ensure all images are uploaded before saving.`);
        return;
    }
    
    // Debug: Log what we're sending
    console.log('üì§ Sending categories data:', cleanedCategories);
    cleanedCategories.forEach((category, catIndex) => {
        console.log(`üìÇ Category ${catIndex}: ${category.category_name}`);
        category.elements.forEach((element, elIndex) => {
            console.log(`  üîó Element ${elIndex}: ${element.name} -> ${element.content}`);
        });
    });
    
    formData.append('categories_data', JSON.stringify(cleanedCategories));
    formData.append('files_already_uploaded', 'true'); // Flag to indicate no file upload needed
    
    // Submit form
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            window.location.href = response.url;
        } else {
            alert('Error saving categories. Please try again.');
            if (overlay) overlay.classList.remove('is-visible');
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Categories & Continue'; }
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('Error saving categories. Please try again.');
        if (overlay) overlay.classList.remove('is-visible');
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Categories & Continue'; }
    });
});

// Initialize display
updateCategoriesDisplay();
updateSaveButton();
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}{{ study.title }} - Analytics{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Study Analytics</h1>
            <p class="text-muted">{{ study.title }} - Detailed timing and interaction analytics</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('dashboard.study_detail', study_id=study._id) }}" class="btn btn-outline-secondary">Back to Study</a>
            <a href="{{ url_for('dashboard.export_study', study_id=study._id, type='json') }}" class="btn btn-outline-primary">Export Data</a>
        </div>
    </div>

    <div class="dashboard-content">
        <!-- Analytics Overview -->
        <div class="content-section">
            <h2>Analytics Overview</h2>
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h4>Task Completion Times</h4>
                    <div class="analytics-content">
                        {% if task_times %}
                        <div class="timing-stats">
                            <div class="stat-item">
                                <span class="stat-label">Average:</span>
                                <span class="stat-value">{{ "%.1f"|format(avg_task_time) }}s</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Median:</span>
                                <span class="stat-value">{{ "%.1f"|format(median_task_time) }}s</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Range:</span>
                                <span class="stat-value">{{ "%.1f"|format(min(task_times)) }}s - {{ "%.1f"|format(max(task_times)) }}s</span>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">No timing data available yet</p>
                        {% endif %}
                    </div>
                </div>

                <div class="analytics-card">
                    <h4>Element Interactions</h4>
                    <div class="analytics-content">
                        {% if element_interactions %}
                        <div class="interaction-summary">
                            <p><strong>{{ element_interactions|length }}</strong> elements tracked</p>
                            <p>View detailed heatmap below</p>
                        </div>
                        {% else %}
                        <p class="text-muted">No interaction data available yet</p>
                        {% endif %}
                    </div>
                </div>

                <div class="analytics-card">
                    <h4>Completion Trends</h4>
                    <div class="analytics-content">
                        {% if completion_trends %}
                        <div class="trend-summary">
                            <p>Data available for analysis</p>
                        </div>
                        {% else %}
                        <p class="text-muted">No trend data available yet</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Timing Distribution -->
        {% if task_times %}
        <div class="content-section">
            <h2>Task Timing Distribution</h2>
            <div class="timing-chart">
                <canvas id="timingChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-legend">
                <p>Distribution of task completion times across all respondents</p>
            </div>
        </div>
        {% endif %}

        <!-- Element Interaction Heatmap -->
        {% if element_interactions %}
        <div class="content-section">
            <h2>Element Interaction Heatmap</h2>
            <div class="heatmap-container">
                <div class="heatmap-grid">
                    {% for element_id, data in element_interactions.items() %}
                    <div class="heatmap-cell" 
                         data-element="{{ element_id }}"
                         data-view-time="{{ data.total_view_time }}"
                         data-hover-count="{{ data.total_hover_count }}"
                         data-click-count="{{ data.total_click_count }}"
                         data-appearance-count="{{ data.appearance_count }}">
                        <div class="cell-header">{{ element_id }}</div>
                        <div class="cell-content">
                            <div class="metric">
                                <span class="metric-label">View:</span>
                                <span class="metric-value">{{ "%.1f"|format(data.avg_view_time) }}s</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Hover:</span>
                                <span class="metric-value">{{ "%.1f"|format(data.avg_hover_count) }}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Clicks:</span>
                                <span class="metric-value">{{ "%.1f"|format(data.avg_click_count) }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="heatmap-legend">
                <div class="legend-item">
                    <span class="legend-color high"></span>
                    <span>High interaction</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color medium"></span>
                    <span>Medium interaction</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color low"></span>
                    <span>Low interaction</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Completion Trends -->
        {% if completion_trends %}
        <div class="content-section">
            <h2>Completion Trends</h2>
            <div class="trends-chart">
                <canvas id="trendsChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-legend">
                <p>Study completion rates over time</p>
            </div>
        </div>
        {% endif %}

        <!-- Data Export Options -->
        <div class="content-section">
            <h2>Export Analytics Data</h2>
            <div class="export-options">
                <a href="{{ url_for('api.export_timing_data', study_id=study._id) }}" class="btn btn-outline-primary">
                    Export Timing Data (JSON)
                </a>
                <a href="{{ url_for('api.element_heatmap', study_id=study._id) }}" class="btn btn-outline-secondary">
                    Export Element Heatmap (JSON)
                </a>
                <a href="{{ url_for('api.abandonment_analysis', study_id=study._id) }}" class="btn btn-outline-info">
                    Export Abandonment Analysis (JSON)
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Task Timing Chart
{% if task_times %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('timingChart').getContext('2d');
    
    // Create histogram data
    const times = {{ task_times|tojson }};
    const maxTime = Math.max(...times);
    const minTime = Math.min(...times);
    const binCount = 10;
    const binSize = (maxTime - minTime) / binCount;
    
    const bins = new Array(binCount).fill(0);
    const labels = [];
    
    for (let i = 0; i < binCount; i++) {
        const start = minTime + (i * binSize);
        const end = start + binSize;
        labels.push(`${start.toFixed(1)}-${end.toFixed(1)}s`);
        
        times.forEach(time => {
            if (time >= start && time < end) {
                bins[i]++;
            }
        });
    }
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Tasks',
                data: bins,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Tasks'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Task Completion Time (seconds)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Task Timing Distribution'
                }
            }
        }
    });
});
{% endif %}

// Element Interaction Heatmap
{% if element_interactions %}
document.addEventListener('DOMContentLoaded', function() {
    const cells = document.querySelectorAll('.heatmap-cell');
    
    // Find max values for normalization
    let maxViewTime = 0, maxHoverCount = 0, maxClickCount = 0;
    
    cells.forEach(cell => {
        const viewTime = parseFloat(cell.dataset.viewTime);
        const hoverCount = parseFloat(cell.dataset.hoverCount);
        const clickCount = parseFloat(cell.dataset.clickCount);
        
        maxViewTime = Math.max(maxViewTime, viewTime);
        maxHoverCount = Math.max(maxHoverCount, hoverCount);
        maxClickCount = Math.max(maxClickCount, clickCount);
    });
    
    // Apply heatmap styling
    cells.forEach(cell => {
        const viewTime = parseFloat(cell.dataset.viewTime);
        const hoverCount = parseFloat(cell.dataset.hoverCount);
        const clickCount = parseFloat(cell.dataset.clickCount);
        
        // Calculate intensity based on multiple factors
        const intensity = (
            (viewTime / maxViewTime * 0.4) +
            (hoverCount / maxHoverCount * 0.3) +
            (clickCount / maxClickCount * 0.3)
        );
        
        // Apply color intensity
        const alpha = 0.3 + (intensity * 0.7);
        cell.style.backgroundColor = `rgba(255, 99, 132, ${alpha})`;
        
        // Add hover effect
        cell.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.zIndex = '10';
        });
        
        cell.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.zIndex = '1';
        });
    });
});
{% endif %}
</script>
{% endblock %}
